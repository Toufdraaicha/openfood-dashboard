{% extends 'base.html.twig' %}

{% block title %}Dashboard â€” OFF{% endblock %}

{% block body %}
    <div class="min-h-screen bg-gray-950">

        {# Navbar #}
        <nav class="border-b border-gray-800 bg-gray-900/80 backdrop-blur sticky top-0 z-50">
            <div class="max-w-7xl mx-auto px-4 h-14 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <span class="text-xl">ğŸ¥—</span>
                    <span class="font-semibold text-white">OFF Dashboard</span>
                    <span class="text-gray-600 text-sm hidden sm:block">{{ dashboard.name }}</span>
                </div>
                <div class="flex items-center gap-3">
                    {% if is_granted('ROLE_ADMIN') %}
                        <a href="/admin" class="text-xs px-2.5 py-1 rounded-md bg-purple-500/10 border border-purple-500/30 text-purple-400 hover:bg-purple-500/20 transition">
                            Admin
                        </a>
                    {% endif %}
                    <span class="text-sm text-gray-500 hidden sm:block">{{ app.user.email }}</span>
                    <a href="{{ path('app_logout') }}"
                       class="text-sm px-3 py-1.5 rounded-lg bg-gray-800 hover:bg-gray-700 text-gray-300 transition">
                        DÃ©connexion
                    </a>
                </div>
            </div>
        </nav>

        <main class="max-w-7xl mx-auto px-4 py-8">

            {# Header #}
            <div class="flex items-center justify-between mb-8">
                <div>
                    <h1 class="text-2xl font-bold text-white">{{ dashboard.name }}</h1>
                    <p class="text-gray-500 text-sm mt-1">
                        {{ dashboard.widgetCount }} widget{{ dashboard.widgetCount > 1 ? 's' : '' }} â€¢
                        Mis Ã  jour le {{ dashboard.updatedAt|date('d/m/Y Ã  H:i') }}
                    </p>
                </div>
                <button
                    onclick="document.getElementById('modal-add-widget').classList.remove('hidden')"
                    class="flex items-center gap-2 px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-500 text-white text-sm font-medium transition"
                >
                    <span class="text-lg leading-none">+</span>
                    Ajouter un widget
                </button>
            </div>

            {# Grid widgets #}
            {% if dashboard.widgets is empty %}
                <div class="text-center py-32">
                    <div class="text-6xl mb-4">ğŸ“Š</div>
                    <p class="text-xl font-medium text-gray-500">Aucun widget</p>
                    <p class="text-gray-600 text-sm mt-2">Cliquez sur "Ajouter un widget" pour commencer</p>
                </div>
            {% else %}
                <div id="widget-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    {% for widget in dashboard.widgets %}
                        <div class="widget-card bg-gray-900 border border-gray-800 hover:border-gray-700 rounded-xl overflow-hidden transition group"
                             data-widget-id="{{ widget.id }}"
                             data-widget-type="{{ widget.type.value }}">

                            {# Header widget #}
                            <div class="flex items-center justify-between px-4 py-3 border-b border-gray-800">
                                <div class="flex items-center gap-2 min-w-0">
                                    <span class="text-gray-600 cursor-grab">â ¿</span>
                                    <span class="text-sm font-medium text-white truncate">{{ widget.title }}</span>
                                    <span class="text-xs px-2 py-0.5 rounded-full bg-gray-800 text-gray-500 shrink-0">
                                    {{ widget.type.label() }}
                                </span>
                                </div>
                                <button
                                    onclick="deleteWidget('{{ widget.id }}')"
                                    class="text-gray-700 hover:text-red-400 transition opacity-0 group-hover:opacity-100 shrink-0 ml-2"
                                    title="Supprimer">âœ•
                                </button>
                            </div>

                            {# Body widget #}
                            <div class="p-4" id="widget-body-{{ widget.id }}">
                                <div class="flex items-center justify-center h-32 text-gray-600 text-sm">
                                    <span class="animate-pulse">Chargement...</span>
                                </div>
                            </div>

                        </div>
                    {% endfor %}
                </div>
            {% endif %}

        </main>

        {# Modal ajout widget #}
        <div id="modal-add-widget" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div class="bg-gray-900 border border-gray-800 rounded-2xl w-full max-w-md p-6 shadow-2xl">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-lg font-semibold text-white">Choisir un widget</h2>
                    <button onclick="document.getElementById('modal-add-widget').classList.add('hidden')"
                            class="text-gray-500 hover:text-white transition text-xl">âœ•</button>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="addWidget('products_search')"
                            class="p-4 rounded-xl bg-gray-800 hover:bg-gray-700 border border-gray-700 hover:border-blue-500 text-left transition">
                        <div class="text-2xl mb-2">ğŸ”</div>
                        <div class="text-sm font-medium text-white">Recherche</div>
                        <div class="text-xs text-gray-500 mt-0.5">Chercher des produits</div>
                    </button>
                    <button onclick="addWidget('nutri_score_stats')"
                            class="p-4 rounded-xl bg-gray-800 hover:bg-gray-700 border border-gray-700 hover:border-green-500 text-left transition">
                        <div class="text-2xl mb-2">ğŸ“Š</div>
                        <div class="text-sm font-medium text-white">Nutri-Score</div>
                        <div class="text-xs text-gray-500 mt-0.5">Stats par catÃ©gorie</div>
                    </button>
                    <button onclick="addWidget('category_top')"
                            class="p-4 rounded-xl bg-gray-800 hover:bg-gray-700 border border-gray-700 hover:border-orange-500 text-left transition">
                        <div class="text-2xl mb-2">ğŸ†</div>
                        <div class="text-sm font-medium text-white">Top catÃ©gorie</div>
                        <div class="text-xs text-gray-500 mt-0.5">Meilleurs produits</div>
                    </button>
                    <button onclick="addWidget('product_detail')"
                            class="p-4 rounded-xl bg-gray-800 hover:bg-gray-700 border border-gray-700 hover:border-purple-500 text-left transition">
                        <div class="text-2xl mb-2">ğŸ“¦</div>
                        <div class="text-sm font-medium text-white">DÃ©tail produit</div>
                        <div class="text-xs text-gray-500 mt-0.5">Info par code-barres</div>
                    </button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // â”€â”€ Charger les donnÃ©es de chaque widget â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        document.querySelectorAll('.widget-card').forEach(card => {
            const id   = card.dataset.widgetId;
            const type = card.dataset.widgetType;
            loadWidgetData(id, type);
        });

        async function loadWidgetData(id, type) {
            const body = document.getElementById('widget-body-' + id);
            try {
                const res  = await fetch(`/dashboard/widget/${id}/data`);
                const json = await res.json();
                renderWidget(body, type, json.data);
            } catch (e) {
                body.innerHTML = '<div class="text-red-400 text-sm text-center py-8">âš ï¸ Erreur de chargement</div>';
            }
        }

        function renderWidget(container, type, data) {
            switch (type) {
                case 'products_search':
                case 'category_top':
                    container.innerHTML = renderProductList(data);
                    break;
                case 'nutri_score_stats':
                    container.innerHTML = renderNutriScore(data);
                    break;
                case 'product_detail':
                    container.innerHTML = renderProductDetail(data);
                    break;
                default:
                    container.innerHTML = '<div class="text-gray-500 text-sm text-center py-8">Widget inconnu</div>';
            }
        }

        function renderProductList(products) {
            if (!products || products.length === 0) {
                return '<div class="text-gray-600 text-sm text-center py-8">Aucun produit</div>';
            }
            const nutriColors = { A:'bg-green-500', B:'bg-lime-500', C:'bg-yellow-500', D:'bg-orange-500', E:'bg-red-500', '?':'bg-gray-500' };
            return `<ul class="space-y-2">
        ${products.slice(0, 5).map(p => `
            <li class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-800 transition">
                ${p.image ? `<img src="${p.image}" class="w-10 h-10 object-contain rounded bg-white" onerror="this.style.display='none'">` : '<div class="w-10 h-10 bg-gray-800 rounded flex items-center justify-center text-gray-600 text-xs">?</div>'}
                <div class="flex-1 min-w-0">
                    <p class="text-sm text-white truncate">${p.name || 'Inconnu'}</p>
                    <p class="text-xs text-gray-500 truncate">${p.brand || ''}</p>
                </div>
                <span class="text-xs font-bold px-1.5 py-0.5 rounded text-white ${nutriColors[p.nutriscore] || 'bg-gray-500'}">${p.nutriscore || '?'}</span>
            </li>
        `).join('')}
    </ul>`;
        }

        function renderNutriScore(stats) {
            if (!stats) return '<div class="text-gray-600 text-sm text-center py-8">Pas de donnÃ©es</div>';
            const colors   = { A:'bg-green-500', B:'bg-lime-500', C:'bg-yellow-500', D:'bg-orange-500', E:'bg-red-500', '?':'bg-gray-700' };
            const total    = Object.values(stats).reduce((a, b) => a + b, 0) || 1;
            return `<div class="space-y-2">
        ${Object.entries(stats).filter(([k]) => k !== '?').map(([grade, count]) => `
            <div class="flex items-center gap-3">
                <span class="text-xs font-bold w-5 text-center text-white px-1 py-0.5 rounded ${colors[grade]}">${grade}</span>
                <div class="flex-1 bg-gray-800 rounded-full h-2">
                    <div class="h-2 rounded-full ${colors[grade]}" style="width: ${Math.round(count/total*100)}%"></div>
                </div>
                <span class="text-xs text-gray-400 w-6 text-right">${count}</span>
            </div>
        `).join('')}
    </div>`;
        }

        function renderProductDetail(product) {
            if (!product || !product.name) {
                return '<div class="text-gray-600 text-sm text-center py-8">Entrez un code-barres dans la config</div>';
            }
            const nutriColors = { A:'bg-green-500', B:'bg-lime-500', C:'bg-yellow-500', D:'bg-orange-500', E:'bg-red-500', '?':'bg-gray-500' };
            return `<div class="flex gap-4 items-start">
        ${product.image ? `<img src="${product.image}" class="w-16 h-16 object-contain rounded bg-white shrink-0">` : ''}
        <div class="flex-1 min-w-0">
            <p class="font-medium text-white truncate">${product.name}</p>
            <p class="text-xs text-gray-500 mt-0.5">${product.brand || ''}</p>
            <span class="inline-block mt-2 text-sm font-bold px-2 py-0.5 rounded text-white ${nutriColors[product.nutriscore] || 'bg-gray-500'}">
                Nutri-Score ${product.nutriscore || '?'}
            </span>
        </div>
    </div>`;
        }

        // â”€â”€ Ajouter un widget â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function addWidget(type) {
            document.getElementById('modal-add-widget').classList.add('hidden');
            const res  = await fetch('/dashboard/widget/add', {
                method:  'POST',
                headers: { 'Content-Type': 'application/json' },
                body:    JSON.stringify({ type }),
            });
            if (res.ok) window.location.reload();
        }

        // â”€â”€ Supprimer un widget â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function deleteWidget(id) {
            if (!confirm('Supprimer ce widget ?')) return;
            const res = await fetch(`/dashboard/widget/${id}/delete`, { method: 'DELETE' });
            if (res.ok) document.querySelector(`[data-widget-id="${id}"]`).remove();
        }
    </script>
{% endblock %}
