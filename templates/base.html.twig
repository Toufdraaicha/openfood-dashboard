<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}OFF Dashboard{% endblock %}</title>

    {# Google Fonts #}
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    {# Notre CSS centralis√© #}
    <link rel="stylesheet" href="{{ asset('styles/app.css') }}">
    
    {# Tailwind pour les utilitaires seulement #}
    <script src="https://cdn.tailwindcss.com"></script>

    {% block stylesheets %}{% endblock %}
</head>

<body>

    {# Flash messages #}
    {% for type, messages in app.flashes %}
        {% for message in messages %}
            <div class="fixed top-4 right-4 z-50 alert alert-{{ type }} animate-fade-in shadow-lg">
                <span class="text-xl">
                    {% if type == 'success' %}‚úÖ
                    {% elseif type == 'error' %}‚ö†Ô∏è
                    {% else %}‚ÑπÔ∏è{% endif %}
                </span>
                <span class="font-medium text-sm">{{ message }}</span>
            </div>
        {% endfor %}
    {% endfor %}

    {% block body %}{% endblock %}

    {# Stimulus via CDN #}
    <script type="module">
        import { Application, Controller } from "https://cdn.jsdelivr.net/npm/@hotwired/stimulus@3.2.2/+esm"
        import Sortable from "https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/+esm"
        
        const app = Application.start()
        
        app.register("dashboard", class extends Controller {
            static targets = ["grid"]
            static values = { reorderUrl: String }
            
            openModal() {
                document.getElementById('modal-add-widget')?.classList.remove('hidden')
            }
            
            closeModal() {
                document.getElementById('modal-add-widget')?.classList.add('hidden')
            }
            
            async addWidget(event) {
                const type = event.params.type
                this.closeModal()
                
                const res = await fetch('/dashboard/widget/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type })
                })
                if (res.ok) window.location.reload()
            }
            
            connect() {
                if (!this.hasGridTarget) return
                
                Sortable.create(this.gridTarget, {
                    animation: 200,
                    handle: '.widget-handle',
                    ghostClass: 'opacity-50',
                    onEnd: async () => {
                        const order = Array.from(this.gridTarget.children).map(el => el.dataset.widgetId)
                        await fetch(this.reorderUrlValue, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ order })
                        })
                    }
                })
            }
        })
        
        app.register("widget", class extends Controller {
            static targets = ["body"]
            static values = { id: String, type: String, dataUrl: String }
            
            connect() { this.loadData() }
            
            async loadData() {
                this.bodyTarget.innerHTML = '<div class="flex items-center justify-center h-40"><div class="text-gray-500 text-sm animate-pulse-slow">Chargement...</div></div>'
                
                try {
                    const res = await fetch(this.dataUrlValue)
                    const json = await res.json()
                    this.renderData(json.data)
                } catch (e) {
                    this.bodyTarget.innerHTML = '<div class="text-center py-8 text-red-500 text-sm">‚ö†Ô∏è Erreur</div>'
                }
            }
            
            renderData(data) {
                switch(this.typeValue) {
                    case 'products_search':
                    case 'category_top':
                        this.renderProducts(data); break
                    case 'nutri_score_stats':
                        this.renderStats(data); break
                    case 'product_detail':
                        this.renderDetail(data); break
                }
            }
            
            renderProducts(products) {
                if (!products?.length) {
                    this.bodyTarget.innerHTML = '<div class="text-center py-12 text-gray-500 text-sm">Aucun produit</div>'
                    return
                }
                
                this.bodyTarget.innerHTML = `<ul class="space-y-2">${products.slice(0,8).map(p => `
                    <li class="flex items-center gap-3 p-2 rounded-xl hover:bg-gray-50 transition">
                        ${p.image ? `<img src="${p.image}" class="w-12 h-12 object-contain rounded-lg bg-white border border-gray-200 p-1">` : '<div class="w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center">üì¶</div>'}
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-semibold text-gray-800 truncate">${this.escape(p.name || 'Inconnu')}</p>
                            <p class="text-xs text-gray-500 truncate">${this.escape(p.brand || '')}</p>
                        </div>
                        <span class="nutriscore nutriscore-${(p.nutriscore || '?').toLowerCase()}">${p.nutriscore||'?'}</span>
                    </li>
                `).join('')}</ul>`
            }
            
            renderStats(stats) {
                if (!stats) {
                    this.bodyTarget.innerHTML = '<div class="text-center py-12 text-gray-500 text-sm">Pas de donn√©es</div>'
                    return
                }
                
                const total = Object.values(stats).reduce((a,b)=>a+b,0)||1
                this.bodyTarget.innerHTML = `<div class="space-y-3">${['A','B','C','D','E'].map(g=>{
                    const c = stats[g]||0
                    const p = Math.round(c/total*100)
                    return `
                    <div class="flex items-center gap-3">
                        <span class="nutriscore nutriscore-${g.toLowerCase()} w-8 text-center">${g}</span>
                        <div class="flex-1 bg-gray-200 rounded-full h-2.5">
                            <div class="nutriscore nutriscore-${g.toLowerCase()} h-2.5 rounded-full transition-all duration-700" style="width:${p}%"></div>
                        </div>
                        <span class="text-xs text-gray-600 font-mono w-10 text-right">${c}</span>
                    </div>
                `}).join('')}</div>
                <div class="mt-4 pt-3 border-t-2 border-gray-100 text-xs flex justify-between">
                    <span class="text-gray-500">Total</span>
                    <span class="text-gray-800 font-semibold">${total} produit${total>1?'s':''}</span>
                </div>`
            }
            
            renderDetail(p) {
                if (!p?.name) {
                    this.bodyTarget.innerHTML = '<div class="text-center py-12 text-gray-500 text-sm">Configurez le code-barres</div>'
                    return
                }
                
                this.bodyTarget.innerHTML = `<div class="flex gap-4">
                    ${p.image ? `<img src="${p.image}" class="w-20 h-20 rounded-xl bg-white border-2 border-gray-200 p-2">` : '<div class="w-20 h-20 bg-gray-100 rounded-xl flex items-center justify-center text-3xl">üì¶</div>'}
                    <div class="flex-1">
                        <h4 class="font-bold text-gray-800 text-sm">${this.escape(p.name)}</h4>
                        <p class="text-xs text-gray-500 mt-1">${this.escape(p.brand||'')}</p>
                        <span class="inline-block mt-2 nutriscore nutriscore-${(p.nutriscore||'?').toLowerCase()}">
                            Nutri-Score ${p.nutriscore||'?'}
                        </span>
                    </div>
                </div>`
            }
            
            escape(text) {
                const div = document.createElement('div')
                div.textContent = text
                return div.innerHTML
            }
            
            openConfig(e) {
                e.preventDefault()
                window.location.href = `/dashboard/widget/${this.idValue}/edit`
            }
            
            async delete(e) {
                e.preventDefault()
                if (!confirm('Supprimer ce widget ?')) return
                const res = await fetch(`/dashboard/widget/${this.idValue}/delete`, {method:'DELETE'})
                if (res.ok) this.element.remove()
            }
        })
        
        console.log('‚úÖ Stimulus loaded')
    </script>

    {% block javascripts %}{% endblock %}
</body>
</html>
